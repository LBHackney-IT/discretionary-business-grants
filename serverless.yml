service: discretionary-business-grants

provider:
  name: aws
  region: eu-west-2
  stage: ${opt:stage}
  dbname: discretionaryBusinessGrantsDb
  iamRoleStatements:
    - Effect: Allow
      Action:
        - s3:PutObject
        - s3:ListBucket
        - s3:GetObject
      Resource: "arn:aws:s3:::${self:custom.bucket}/*"

resources:
  Resources:
    discretionaryBusinessGrantsSupportingDocumentsBucket:
      Type: AWS::S3::Bucket
      DeletionPolicy: Retain
      Properties:
        BucketName: ${self:custom.bucket}
        PublicAccessBlockConfiguration:
          BlockPublicAcls: true
          BlockPublicPolicy: true
          IgnorePublicAcls: true
          RestrictPublicBuckets: true
        BucketEncryption:
          ServerSideEncryptionConfiguration:
            - ServerSideEncryptionByDefault:
                SSEAlgorithm: AES256
        VersioningConfiguration:
          Status: Enabled
        CorsConfiguration:
          CorsRules:
            -
              AllowedOrigins:
                - '*'
              AllowedHeaders:
                - '*'
              AllowedMethods:
                - PUT
                - POST
              MaxAge: 3000
    discretionaryBusinessGrantsDbSecurityGroup:
      Type: AWS::EC2::SecurityGroup
      Properties:
        GroupDescription: Access to Postgres
        SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: '5432'
          ToPort: '5432'
          CidrIp: 0.0.0.0/0

    discretionaryBusinessGrantsDb:
      Type: "AWS::RDS::DBInstance"
      Properties:
        DBInstanceIdentifier: "discretionary-business-grants-db-${self:provider.stage}"
        DBName: ${self:provider.dbname}
        AllocatedStorage: 5
        DBInstanceClass: "db.t3.micro"
        DeletionProtection: false
        Engine: "postgres"
        EngineVersion: "11.22"
        CACertificateIdentifier: "rds-ca-rsa2048-g1"
        MasterUsername: ${env:MASTER_USERNAME}
        MasterUserPassword: ${env:MASTER_USER_PASSWORD}
        VPCSecurityGroups:
        - Fn::GetAtt:
          - discretionaryBusinessGrantsDbSecurityGroup
          - GroupId
        Tags:
          - Key: "Name"
            Value: "discretionaryBusinessGrantsDb"
          - Key: "STAGE"
            Value: ${self:provider.stage}
          - Key: "BackupPolicy"
            Value: "Prod"
      DeletionPolicy: "Snapshot"

custom:
  bucket: ${self:service}-supporting-documents-${self:provider.stage}

